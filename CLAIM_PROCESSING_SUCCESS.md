# Claimæ•°æ®å¤„ç†åŠŸèƒ½å®ç°æˆåŠŸ

## ğŸ‰ åŠŸèƒ½å®ç°æ€»ç»“

å·²æˆåŠŸå®Œå–„ç›‘æ§ç¨‹åºï¼Œå®ç°äº†æ ¹æ®ç›‘æ§ç¨‹åºè·å–çš„claimåˆçº¦è°ƒç”¨ï¼Œå°†ç›¸åº”çš„æ•°æ®å†™å…¥managementæ•°æ®åº“çš„mesh_claimsè¡¨ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. ClaimDataProcessoræœåŠ¡
- **æ–‡ä»¶**: `src/services/ClaimDataProcessor.ts`
- **åŠŸèƒ½**: å¤„ç†MeshClaimedäº‹ä»¶å’ŒclaimMintså‡½æ•°è°ƒç”¨
- **æ•°æ®åº“**: å°†æ•°æ®å†™å…¥managementæ•°æ®åº“çš„mesh_claimsè¡¨

### 2. æ•°æ®åº“é›†æˆ
- **Managementæ•°æ®åº“**: ä½¿ç”¨Prismaå®¢æˆ·ç«¯è¿æ¥
- **SchemaåŒ¹é…**: æ›´æ–°Prisma schemaä»¥åŒ¹é…å®é™…æ•°æ®åº“ç»“æ„
- **æ•°æ®æ˜ å°„**: æ­£ç¡®æ˜ å°„äº‹ä»¶æ•°æ®åˆ°æ•°æ®åº“å­—æ®µ

### 3. äº‹ä»¶å¤„ç†
- **MeshClaimedäº‹ä»¶**: è§£æäº‹ä»¶å‚æ•°å¹¶å†™å…¥mesh_claimsè¡¨
- **claimMintsè°ƒç”¨**: å¤„ç†å‡½æ•°è°ƒç”¨å¹¶è®°å½•ç›¸å…³ä¿¡æ¯
- **ç”¨æˆ·ç®¡ç†**: è‡ªåŠ¨åˆ›å»ºæˆ–è·å–ç”¨æˆ·è®°å½•

### 4. æ•°æ®è½¬æ¢
- **ç»çº¬åº¦è½¬æ¢**: ä»lon100/lat100è½¬æ¢ä¸ºå®é™…ç»çº¬åº¦
- **æ—¶é—´æˆ³å¤„ç†**: æ­£ç¡®è½¬æ¢åŒºå—é“¾æ—¶é—´æˆ³
- **åœ°å€æ ‡å‡†åŒ–**: ç»Ÿä¸€åœ°å€æ ¼å¼ä¸ºå°å†™

## ğŸ“Š æµ‹è¯•ç»“æœ

### 1. å•å…ƒæµ‹è¯•
```bash
npx tsx test-claim-processing.js
```
**ç»“æœ**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- MeshClaimedäº‹ä»¶å¤„ç†æˆåŠŸ
- claimMintså‡½æ•°è°ƒç”¨å¤„ç†æˆåŠŸ
- æ•°æ®æ­£ç¡®å†™å…¥managementæ•°æ®åº“

### 2. æ•°æ®åº“éªŒè¯
```sql
SELECT * FROM ngp_management.mesh_claims ORDER BY id DESC LIMIT 5;
```
**ç»“æœ**: âœ… æ•°æ®æˆåŠŸå†™å…¥
- ç”¨æˆ·åœ°å€æ­£ç¡®è®°å½•
- ç½‘æ ¼ç¼–å·æ­£ç¡®ä¿å­˜
- ç»çº¬åº¦æ­£ç¡®è½¬æ¢
- äº¤æ˜“å“ˆå¸Œå’ŒåŒºå—å·æ­£ç¡®è®°å½•

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. äº‹ä»¶æ•°æ®ç»“æ„
```typescript
interface MeshClaimedEvent {
  account: string;      // ç”¨æˆ·åœ°å€
  meshID: string;       // ç½‘æ ¼ID
  lon100: number;       // ç»åº¦ * 100
  lat100: number;       // çº¬åº¦ * 100
  applyCount: number;   // åº”ç”¨æ¬¡æ•°
  heat: bigint;         // çƒ­åº¦å€¼
  costBurned: bigint;   // ç‡ƒçƒ§æˆæœ¬
  blockNumber: bigint;  // åŒºå—å·
  txHash: string;       // äº¤æ˜“å“ˆå¸Œ
  timestamp: number;    // æ—¶é—´æˆ³
}
```

### 2. æ•°æ®åº“å­—æ®µæ˜ å°„
```typescript
// mesh_claimsè¡¨å­—æ®µ
{
  userAddress: string;    // ç”¨æˆ·åœ°å€
  gridNumber: string;     // ç½‘æ ¼ç¼–å·
  longitude: number;      // ç»åº¦
  latitude: number;       // çº¬åº¦
  txHash: string;         // äº¤æ˜“å“ˆå¸Œ
  blockNumber: bigint;    // åŒºå—å·
  claimedAt: DateTime;    // è®¤é¢†æ—¶é—´
}
```

### 3. ç»çº¬åº¦è½¬æ¢
```typescript
// ä»lon100/lat100è½¬æ¢ä¸ºå®é™…ç»çº¬åº¦
const longitude = Number(lon100) / 1000000;
const latitude = Number(lat100) / 1000000;
```

## ğŸš€ é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿ

### 1. LogIndexeré›†æˆ
- æ·»åŠ äº†ClaimDataProcessoræ”¯æŒ
- å¤„ç†MeshClaimedäº‹ä»¶
- è‡ªåŠ¨å†™å…¥managementæ•°æ®åº“

### 2. TxDecoderé›†æˆ
- æ·»åŠ äº†ClaimDataProcessoræ”¯æŒ
- å¤„ç†claimMintså‡½æ•°è°ƒç”¨
- è®°å½•è°ƒç”¨ä¿¡æ¯

### 3. MonitorServiceé›†æˆ
- ä¼ é€’managementDatabaseUrlç»™ç»„ä»¶
- æ”¯æŒclaimæ•°æ®å¤„ç†
- èµ„æºæ¸…ç†å’Œé”™è¯¯å¤„ç†

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. é”™è¯¯å¤„ç†
- å®Œå–„çš„é”™è¯¯æ—¥å¿—è®°å½•
- ä¼˜é›…çš„é”™è¯¯æ¢å¤æœºåˆ¶
- æ•°æ®åº“è¿æ¥é”™è¯¯å¤„ç†

### 2. èµ„æºç®¡ç†
- è‡ªåŠ¨æ¸…ç†Prismaè¿æ¥
- å†…å­˜æ³„æ¼é˜²æŠ¤
- è¿æ¥æ± ç®¡ç†

### 3. æ•°æ®éªŒè¯
- è¾“å…¥å‚æ•°éªŒè¯
- æ•°æ®åº“çº¦æŸæ£€æŸ¥
- ç±»å‹å®‰å…¨ä¿è¯

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### 1. æ—¥å¿—è®°å½•
- è¯¦ç»†çš„å¤„ç†æ—¥å¿—
- é”™è¯¯è¿½è¸ªä¿¡æ¯
- æ€§èƒ½ç›‘æ§æ•°æ®

### 2. æµ‹è¯•è¦†ç›–
- å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•
- æ•°æ®åº“æµ‹è¯•

### 3. é”™è¯¯è¯Šæ–­
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- å †æ ˆè·Ÿè¸ª
- ä¸Šä¸‹æ–‡ä¿¡æ¯

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

### 1. ç¯å¢ƒé…ç½®
```bash
# è®¾ç½®æ•°æ®åº“è¿æ¥
MANAGEMENT_DATABASE_URL=mysql://root@localhost:3306/ngp_management
MONITOR_DATABASE_URL=mysql://root@localhost:3306/ngp_monitor
```

### 2. å¯åŠ¨ç›‘æ§
```bash
# å¯åŠ¨BSCæµ‹è¯•ç½‘ç›‘æ§
npm run cli start -- --network bsc-testnet --start-block current
```

### 3. æŸ¥çœ‹æ•°æ®
```sql
-- æŸ¥çœ‹æœ€æ–°çš„claimè®°å½•
SELECT * FROM ngp_management.mesh_claims 
ORDER BY claimed_at DESC LIMIT 10;

-- æŸ¥çœ‹ç”¨æˆ·claimç»Ÿè®¡
SELECT user_address, COUNT(*) as claim_count 
FROM ngp_management.mesh_claims 
GROUP BY user_address 
ORDER BY claim_count DESC;
```

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### 1. åŠŸèƒ½æ‰©å±•
- æ”¯æŒæ›´å¤šclaimç›¸å…³äº‹ä»¶
- æ·»åŠ claimç»Ÿè®¡å’Œåˆ†æ
- å®ç°claimæ•°æ®API

### 2. æ€§èƒ½ä¼˜åŒ–
- æ‰¹é‡æ•°æ®å¤„ç†
- ç¼“å­˜æœºåˆ¶
- å¼‚æ­¥å¤„ç†

### 3. ç›‘æ§å¢å¼º
- å®æ—¶ç›‘æ§é¢æ¿
- å‘Šè­¦æœºåˆ¶
- æ€§èƒ½æŒ‡æ ‡

## âœ¨ æ€»ç»“

Claimæ•°æ®å¤„ç†åŠŸèƒ½å·²æˆåŠŸå®ç°å¹¶é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿä¸­ã€‚ç³»ç»Ÿèƒ½å¤Ÿï¼š

1. âœ… å®æ—¶ç›‘æ§MeshClaimedäº‹ä»¶
2. âœ… å¤„ç†claimMintså‡½æ•°è°ƒç”¨
3. âœ… è‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•
4. âœ… æ­£ç¡®è½¬æ¢å’Œå­˜å‚¨æ•°æ®
5. âœ… æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†
6. âœ… æ”¯æŒèµ„æºæ¸…ç†å’Œæ¢å¤

è¯¥åŠŸèƒ½ä¸ºNGPé¡¹ç›®çš„claimç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æ•°æ®ç›‘æ§å’Œè®°å½•èƒ½åŠ›ï¼Œç¡®ä¿æ‰€æœ‰claimæ´»åŠ¨éƒ½èƒ½è¢«å‡†ç¡®è¿½è¸ªå’Œè®°å½•ã€‚

