# NGP Monitor Service

ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„å¤šç½‘ç»œåŒºå—é“¾ç›‘æ§æœåŠ¡ï¼Œç”¨äºå®æ—¶ç›‘æ§å’Œè®°å½•æŒ‡å®šåˆçº¦çš„äº‹ä»¶å’Œå‡½æ•°è°ƒç”¨ã€‚


## ğŸ“š æ–‡æ¡£å¯¼èˆª

- [æŠ€æœ¯æ–‡æ¡£](TECHNICAL_DOCUMENTATION.md) - å®Œæ•´çš„ç³»ç»Ÿæ¶æ„å’Œæ ¸å¿ƒç®—æ³•è¯´æ˜
- [æ¶æ„å›¾](ARCHITECTURE_DIAGRAM.md) - ç³»ç»Ÿæ¶æ„å’Œç»„ä»¶å…³ç³»å›¾
- [APIæ–‡æ¡£](API_DOCUMENTATION.md) - RESTful APIæ¥å£è¯´æ˜
- [å¼€å‘æŒ‡å—](DEVELOPER_GUIDE.md) - å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Node.js >= 18.0.0
- MySQL >= 8.0
- npm >= 8.0.0

### å®‰è£…å’Œé…ç½®
```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd monitor-service

# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®æ•°æ®åº“è¿æ¥

# åˆå§‹åŒ–æ•°æ®åº“
npx prisma generate
npx prisma db push
```

### å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨BSCæµ‹è¯•ç½‘ç›‘æ§
npm run cli start -- --network bsc-testnet --start-block current

# å¯åŠ¨APIæœåŠ¡å™¨
npm run api
```

## âœ¨ ä¸»è¦ç‰¹æ€§

- ğŸ”„ **å¤šç½‘ç»œæ”¯æŒ**: åŒæ—¶ç›‘æ§å¤šä¸ªåŒºå—é“¾ç½‘ç»œ
- ğŸ”„ **åŠ¨æ€é…ç½®**: ä»ç®¡ç†æ•°æ®åº“åŠ¨æ€è·å–åˆçº¦åœ°å€
- ğŸ”„ **RPCè½®æ¢**: å¤šä¸ªRPCèŠ‚ç‚¹è‡ªåŠ¨åˆ‡æ¢ï¼Œæé«˜ç¨³å®šæ€§
- ğŸ”„ **æ™ºèƒ½å­˜å‚¨**: åªä¿å­˜åŒ…å«ç›¸å…³åˆçº¦æ´»åŠ¨çš„åŒºå—
- ğŸ”„ **æ•°æ®å»é‡**: é˜²æ­¢é‡å¤æ‰«æäº§ç”Ÿé‡å¤è®°å½•
- ğŸ”„ **å¼‚å¸¸æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹åŒºå—é‡ç»„ç­‰å¼‚å¸¸æƒ…å†µ
- ğŸ”„ **RESTful API**: æä¾›å®Œæ•´çš„æŸ¥è¯¢æ¥å£

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Management    â”‚    â”‚   Monitor       â”‚    â”‚   Blockchain    â”‚
â”‚   Database      â”‚â—„â”€â”€â–ºâ”‚   Service       â”‚â—„â”€â”€â–ºâ”‚   Networks      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Monitor       â”‚
                       â”‚   Database      â”‚
                       â”‚                 â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ ¸å¿ƒç»„ä»¶

- **MultiNetworkManager**: å¤šç½‘ç»œç®¡ç†
- **MonitorService**: ç›‘æ§æœåŠ¡æ ¸å¿ƒ
- **BlockScanner**: åŒºå—æ‰«æå™¨
- **LogIndexer**: äº‹ä»¶æ—¥å¿—è§£æå™¨
- **TxDecoder**: äº¤æ˜“è§£ç å™¨
- **RpcManager**: RPCè¿æ¥ç®¡ç†å™¨
- **ContractSyncService**: åˆçº¦åŒæ­¥æœåŠ¡

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨
- **Contract**: åˆçº¦æ³¨å†Œè¡¨
- **Block**: åŒºå—ä¿¡æ¯ï¼ˆåªä¿å­˜ç›¸å…³åŒºå—ï¼‰
- **Event**: é“¾ä¸Šäº‹ä»¶
- **FunctionCall**: å‡½æ•°è°ƒç”¨è®°å½•
- **Anomaly**: å¼‚å¸¸è®°å½•
- **Checkpoint**: å¤„ç†è¿›åº¦

### æ•°æ®å»é‡
- Block: `chainId + blockNumber`
- Event: `chainId + txHash + logIndex`
- FunctionCall: `chainId + txHash`
- Contract: `address + chainId`

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡
```bash
MANAGEMENT_DATABASE_URL=mysql://root@localhost:3306/ngp_management
MONITOR_DATABASE_URL=mysql://root@localhost:3306/ngp_monitor
LOG_LEVEL=info
```

### å¤šç½‘ç»œé…ç½®
```json
{
  "networks": {
    "bsc-testnet": {
      "name": "BSC Testnet",
      "chainId": 97,
      "rpcHttp": [
        "https://data-seed-prebsc-1-s1.binance.org:8545",
        "https://data-seed-prebsc-2-s1.binance.org:8545"
      ],
      "startBlock": 38000000,
      "contracts": [...]
    }
  }
}
```

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### å‘½ä»¤è¡Œæ“ä½œ
```bash
# å¯åŠ¨æŒ‡å®šç½‘ç»œ
npm run cli start -- --network bsc-testnet --start-block 65574200

# æŸ¥çœ‹ç½‘ç»œçŠ¶æ€
npm run cli network status

# åŒæ­¥åˆçº¦
npm run cli sync-contracts -- --network bsc-testnet
```

### APIè°ƒç”¨
```bash
# è·å–æ‰€æœ‰åˆçº¦
curl "http://localhost:3000/api/contracts?chainId=97"

# è·å–åˆçº¦äº‹ä»¶
curl "http://localhost:3000/api/contracts/0x.../events?chainId=97"

# è·å–ç»Ÿè®¡ä¿¡æ¯
curl "http://localhost:3000/api/stats"
```

## ğŸ” ç›‘æ§å’Œè¿ç»´

### å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl "http://localhost:3000/health"

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/monitor.log
```

### æ€§èƒ½ç›‘æ§
- åŒºå—æ‰«æé€Ÿåº¦
- RPCè¿æ¥çŠ¶æ€
- æ•°æ®åº“æ€§èƒ½
- å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°ç½‘ç»œ
1. åœ¨`config/multi-network.json`ä¸­æ·»åŠ ç½‘ç»œé…ç½®
2. ç¡®ä¿RPCèŠ‚ç‚¹å¯ç”¨
3. æµ‹è¯•ç½‘ç»œè¿æ¥
4. å¯åŠ¨ç›‘æ§æœåŠ¡

### æ·»åŠ æ–°åˆçº¦
1. åœ¨ç®¡ç†æ•°æ®åº“ä¸­æ³¨å†Œåˆçº¦
2. æ·»åŠ åˆçº¦ABIæ–‡ä»¶
3. é‡å¯ç›‘æ§æœåŠ¡æˆ–ç­‰å¾…åŠ¨æ€æ›´æ–°

### è‡ªå®šä¹‰å¼‚å¸¸æ£€æµ‹
```typescript
async checkCustomAnomaly(block: any): Promise<boolean> {
  // è‡ªå®šä¹‰æ£€æµ‹é€»è¾‘
  if (/* æ£€æµ‹æ¡ä»¶ */) {
    await this.prisma.anomaly.create({
      data: {
        chainId: this.config.chainId,
        type: 'custom_anomaly',
        key: block.number.toString(),
        details: { /* è¯¦ç»†ä¿¡æ¯ */ }
      }
    });
    return true;
  }
  return false;
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å­˜å‚¨ä¼˜åŒ–
- åªä¿å­˜åŒ…å«ç›¸å…³åˆçº¦æ´»åŠ¨çš„åŒºå—
- ä½¿ç”¨upsertæ“ä½œé˜²æ­¢é‡å¤æ•°æ®
- åˆç†çš„æ•°æ®åº“ç´¢å¼•è®¾è®¡

### ç½‘ç»œä¼˜åŒ–
- å¤šRPCèŠ‚ç‚¹è½®æ¢
- è‡ªåŠ¨æ•…éšœåˆ‡æ¢
- è¿æ¥æ± ç®¡ç†

### å†…å­˜ä¼˜åŒ–
- åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **RPCè¿æ¥å¤±è´¥**: æ£€æŸ¥RPCèŠ‚ç‚¹çŠ¶æ€ï¼Œä½¿ç”¨è½®æ¢æœºåˆ¶
2. **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ£€æŸ¥æ•°æ®åº“é…ç½®å’Œè¿æ¥çŠ¶æ€
3. **å†…å­˜æ³„æ¼**: ä½¿ç”¨è°ƒè¯•å·¥å…·åˆ†æå†…å­˜ä½¿ç”¨
4. **æ‰«æåœæ­¢**: æ£€æŸ¥å¼‚å¸¸è®°å½•å’Œæ—¥å¿—

### è°ƒè¯•å·¥å…·
```bash
# æ•°æ®åº“è°ƒè¯•
npx prisma studio

# æ€§èƒ½åˆ†æ
npx clinic doctor -- node src/index.js

# å†…å­˜åˆ†æ
node --inspect src/index.js
```

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒå¤šç½‘ç»œç›‘æ§
- åŠ¨æ€é…ç½®ç®¡ç†
- RPCè½®æ¢æœºåˆ¶
- æ™ºèƒ½å­˜å‚¨ä¼˜åŒ–
- å®Œæ•´çš„APIæ¥å£

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- åˆ›å»º Issue
- å‘é€é‚®ä»¶
- æŸ¥çœ‹æ–‡æ¡£

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„ç›‘æ§æœåŠ¡ï¼Œè¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è°¨æ…ä½¿ç”¨ï¼Œå¹¶ç¡®ä¿å……åˆ†æµ‹è¯•ã€‚